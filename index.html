<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Novel Translator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #1f2937;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .tab-active {
            background-color: #3b82f6;
            color: white;
        }
        .tab-inactive {
            background-color: #374151;
            color: #d1d5db;
        }
        /* Styles for collapsible prompt */
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
    </style>
    <script>
        window.GEMINI_API_KEY = ""; 
    </script>
</head>
<body class="bg-gray-900 text-gray-200 flex flex-col min-h-screen">

    <!-- Header -->
    <header class="bg-gray-800/50 backdrop-blur-sm border-b border-gray-700 sticky top-0 z-20">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-book-open text-2xl text-blue-400"></i>
                    <h1 class="text-xl font-bold tracking-tight text-white">AI Novel Translator</h1>
                </div>
                <a href="https://github.com/deva-hari/Translator-V2" target="_blank" class="text-gray-400 hover:text-white transition-colors">
                    <i class="fab fa-github text-2xl"></i>
                </a>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow container mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="flex flex-col space-y-6">

            <!-- Settings Section -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div id="apiKeyContainer" class="bg-gray-800 p-4 rounded-lg border border-gray-700">
                    <label for="apiKey" class="block text-sm font-medium text-gray-400 mb-2">Your Gemini API Key</label>
                    <div class="relative">
                        <input type="password" id="apiKey" class="w-full bg-gray-900 border border-gray-600 rounded-md px-4 py-2 text-white focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="Enter your Google AI Studio API Key">
                        <button id="toggleApiVisibility" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-500 hover:text-gray-300">
                           <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
                    <label for="modelSelector" class="block text-sm font-medium text-gray-400 mb-2">Choose a Model</label>
                    <select id="modelSelector" class="w-full bg-gray-900 border border-gray-600 rounded-md px-4 py-2 text-white focus:ring-2 focus:ring-blue-500 focus:outline-none">
                        <option value="gemini-2.0-flash">Gemini 2.0 Flash (Fast & Efficient)</option>
                        <option value="gemini-2.5-flash">Gemini 2.5 (Higher Quality)</option>
                        <option value="gemini-2.0-flash-lite">Gemini 2.0 Flash Lite (Stupid Fast, So-So)</option>
                        <option value="gemini-2.5-flash-lite-preview-06-17">Gemini 2.5 Flash (Stupid Fast, So-So, Unstable)</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-2">Free tier offers 60 requests per minute. Batch translation includes a 1s delay per file.</p>
                </div>
            </div>

            <!-- Input Section -->
            <div class="bg-gray-800 rounded-lg border border-gray-700 p-4">
                <div class="mb-4 border-b border-gray-700">
                    <nav class="flex space-x-2" aria-label="Tabs">
                        <button id="tab-text" class="tab-active px-4 py-2 text-sm font-medium rounded-t-md">Text / Single File</button>
                        <button id="tab-batch" class="tab-inactive px-4 py-2 text-sm font-medium rounded-t-md">Multiple Files (Batch)</button>
                    </nav>
                </div>
                
                 <!-- Collapsible Prompt Section -->
                <div class="mb-4">
                    <button id="prompt-toggle" class="w-full flex justify-between items-center text-left p-3 bg-gray-700 hover:bg-gray-600 rounded-md">
                        <span class="font-medium text-gray-200">Customize Translation Prompt</span>
                        <i id="prompt-chevron" class="fas fa-chevron-down transition-transform"></i>
                    </button>
                    <div id="prompt-content" class="collapsible-content">
                        <textarea id="promptText" class="w-full h-48 mt-2 bg-gray-900 p-3 text-gray-300 resize-none focus:outline-none rounded-md custom-scrollbar"></textarea>
                    </div>
                </div>


                <!-- Text / Single File Input -->
                <div id="panel-text">
                    <textarea id="inputText" class="w-full h-48 bg-gray-900 p-4 text-gray-300 resize-none focus:outline-none rounded-md custom-scrollbar" placeholder="Paste your Chinese novel text here, or upload a single .txt file..."></textarea>
                    <div class="flex justify-between items-center mt-3">
                         <label for="singleFileInput" class="cursor-pointer px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md text-sm font-medium transition-colors flex items-center space-x-2">
                            <i class="fas fa-upload"></i>
                            <span>Upload Single .txt</span>
                        </label>
                        <input type="file" id="singleFileInput" class="hidden" accept=".txt">
                        <button id="clearBtn" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-md text-sm font-medium transition-colors">Clear</button>
                    </div>
                </div>

                <!-- Multiple File Input -->
                <div id="panel-batch" class="hidden">
                    <div class="flex flex-col items-center justify-center border-2 border-dashed border-gray-600 rounded-lg p-10">
                        <i class="fas fa-folder-open text-4xl text-gray-500 mb-4"></i>
                        <label for="multiFileInput" class="relative cursor-pointer bg-blue-600 text-white font-medium py-2 px-4 rounded-md hover:bg-blue-700">
                            <span>Select Files</span>
                            <input id="multiFileInput" type="file" multiple class="sr-only" accept=".txt">
                        </label>
                        <p class="mt-2 text-sm text-gray-500" id="file-list-info">Select multiple .txt files to translate and zip.</p>
                    </div>
                </div>
                 <!-- Translate Action Button -->
                <div class="mt-6 flex justify-center">
                    <button id="translateBtn" class="px-8 py-4 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg text-lg transition-all transform hover:scale-105 shadow-lg shadow-blue-500/20 flex items-center space-x-3">
                        <i class="fas fa-language text-2xl"></i>
                        <span id="translateBtnText">Translate Now</span>
                    </button>
                </div>
            </div>

            <!-- Output Section -->
            <div id="outputContainer" class="bg-gray-800 rounded-lg border border-gray-700 min-h-[300px] flex flex-col overflow-hidden">
                <div class="flex items-center justify-between p-3 border-b border-gray-700 bg-gray-800">
                    <h2 id="outputTitle" class="font-semibold text-lg">Translated Text</h2>
                    <div id="outputActions" class="flex items-center space-x-2">
                        <button id="copyBtn" class="px-3 py-1 bg-gray-600 hover:bg-gray-700 text-white rounded-md text-sm font-medium transition-colors flex items-center space-x-2" disabled>
                            <i class="fas fa-copy"></i>
                            <span id="copyBtnText">Copy</span>
                        </button>
                        <button id="downloadMdBtn" class="px-3 py-1 bg-green-600 hover:bg-green-700 text-white rounded-md text-sm font-medium transition-colors flex items-center space-x-2" disabled>
                            <i class="fas fa-download"></i>
                            <span>.md</span>
                        </button>
                    </div>
                </div>
                <div id="outputText" class="w-full h-full flex-grow bg-gray-900 p-6 text-gray-300 overflow-y-auto custom-scrollbar prose prose-invert max-w-none prose-p:my-2 prose-headings:my-3">
                     <div id="placeholder" class="flex flex-col items-center justify-center h-full text-gray-500">
                        <i class="fas fa-magic text-4xl mb-4"></i>
                        <p class="text-center">Your translated text will appear here.</p>
                    </div>
                    <div id="loadingIndicator" class="hidden flex-col items-center justify-center h-full text-gray-400">
                        <div class="loader"></div>
                        <p id="loadingText" class="mt-4 text-center">Translating with AI... this may take a moment.</p>
                    </div>
                </div>
            </div>
        </div>
        
         <!-- Message Box -->
        <div id="messageBox" class="hidden fixed bottom-5 right-5 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50">
            <p id="messageText"></p>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- GLOBAL STATE ---
            let currentMode = 'text'; // 'text' or 'batch'
            let translatedContent = '';
            let filesToProcess = [];
            const defaultPrompt = `You are an expert literary translator specializing in Chinese-to-English translation with deep cultural understanding, creative flair, and mastery of language. Your task is to translate the following Chinese novel chapter into polished, natural English, preserving cultural authenticity, emotional nuance, and literary style. This should read like a native English literary work that amazes readers and earns praise.
Your language should be:
- Smooth, emotionally rich, and well-paced
- Easy to understand for common English readers
- Not overly simplistic or childish—keep a refined tone.
Translation Guidelines:
1. Maintain original tone, style, rhythm, and emotional depth.
2. Preserve paragraph structure and pacing.
3. Keep proper names and places in pinyin.
4. Translate idioms and proverbs as follows: Use an English equivalent, then include the original Chinese in pinyin.
5. Preserve Chinese internet slang and acronyms, explaining them in footnotes.
6. Maintain honorifics, prefixes, and suffixes.
7. Preserve wordplay and puns, reconstructing in English or explaining in footnotes.
8. For cultural concepts, keep the Chinese term in pinyin and briefly explain in parentheses on first use.
Formatting Requirements:
1. Preserve paragraph spacing.
2. Format dialogue using quotation marks.
3. Use *italics* for internal thoughts or emphasis.
4. Add numbered footnotes at the end for cultural context, slang, or idioms.
Quality Checklist (Mandatory):
- Smooth, natural English flow.
- No content lost or added.
- Character names and terms consistent.
- No chinese characters; everything should be translated into English along with pinyin where necessary.
- Follow formatting requirements meticulously.
Your translation should be beautiful, authentic, accessible, and faithful. Output only the translated text and footnotes. Do not explain your process.`;


            // --- ELEMENT REFERENCES ---
            const elements = {
                apiKeyContainer: document.getElementById('apiKeyContainer'),
                apiKeyInput: document.getElementById('apiKey'),
                toggleApiVisibilityBtn: document.getElementById('toggleApiVisibility'),
                modelSelector: document.getElementById('modelSelector'),
                inputText: document.getElementById('inputText'),
                outputText: document.getElementById('outputText'),
                outputContainer: document.getElementById('outputContainer'),
                outputTitle: document.getElementById('outputTitle'),
                outputActions: document.getElementById('outputActions'),
                translateBtn: document.getElementById('translateBtn'),
                translateBtnText: document.getElementById('translateBtnText'),
                clearBtn: document.getElementById('clearBtn'),
                singleFileInput: document.getElementById('singleFileInput'),
                multiFileInput: document.getElementById('multiFileInput'),
                fileListInfo: document.getElementById('file-list-info'),
                copyBtn: document.getElementById('copyBtn'),
                copyBtnText: document.getElementById('copyBtnText'),
                downloadMdBtn: document.getElementById('downloadMdBtn'),
                placeholder: document.getElementById('placeholder'),
                loadingIndicator: document.getElementById('loadingIndicator'),
                loadingText: document.getElementById('loadingText'),
                messageBox: document.getElementById('messageBox'),
                messageText: document.getElementById('messageText'),
                tabText: document.getElementById('tab-text'),
                tabBatch: document.getElementById('tab-batch'),
                panelText: document.getElementById('panel-text'),
                panelBatch: document.getElementById('panel-batch'),
                promptToggle: document.getElementById('prompt-toggle'),
                promptContent: document.getElementById('prompt-content'),
                promptChevron: document.getElementById('prompt-chevron'),
                promptText: document.getElementById('promptText'),
            };

            // --- INITIALIZATION ---
            if (window.GEMINI_API_KEY && window.GEMINI_API_KEY.length > 0) {
                elements.apiKeyContainer.style.display = 'none';
            } else {
                elements.apiKeyInput.value = localStorage.getItem('geminiApiKey') || '';
                elements.apiKeyInput.addEventListener('input', () => {
                    localStorage.setItem('geminiApiKey', elements.apiKeyInput.value);
                });
            }
            elements.promptText.value = defaultPrompt;

            // --- EVENT LISTENERS ---
            elements.toggleApiVisibilityBtn.addEventListener('click', toggleApiVisibility);
            elements.promptToggle.addEventListener('click', togglePromptVisibility);
            elements.clearBtn.addEventListener('click', () => { elements.inputText.value = ''; });
            elements.singleFileInput.addEventListener('change', handleSingleFile);
            elements.multiFileInput.addEventListener('change', handleMultiFile);
            elements.translateBtn.addEventListener('click', handlePrimaryAction);
            elements.copyBtn.addEventListener('click', copyOutput);
            elements.downloadMdBtn.addEventListener('click', () => downloadFile(translatedContent, 'translation.md', 'text/markdown'));
            elements.tabText.addEventListener('click', () => switchMode('text'));
            elements.tabBatch.addEventListener('click', () => switchMode('batch'));

            // --- UI FUNCTIONS ---
            function togglePromptVisibility() {
                const content = elements.promptContent;
                if (content.style.maxHeight) {
                    content.style.maxHeight = null;
                    elements.promptChevron.classList.remove('rotate-180');
                } else {
                    content.style.maxHeight = content.scrollHeight + "px";
                    elements.promptChevron.classList.add('rotate-180');
                }
            }

            function switchMode(mode) {
                currentMode = mode;
                if (mode === 'text') {
                    elements.tabText.classList.replace('tab-inactive', 'tab-active');
                    elements.tabBatch.classList.replace('tab-active', 'tab-inactive');
                    elements.panelText.style.display = 'block';
                    elements.panelBatch.style.display = 'none';
                    elements.outputContainer.style.display = 'flex';
                    elements.translateBtnText.textContent = 'Translate Now';
                } else { // batch mode
                    elements.tabBatch.classList.replace('tab-inactive', 'tab-active');
                    elements.tabText.classList.replace('tab-active', 'tab-inactive');
                    elements.panelBatch.style.display = 'block';
                    elements.panelText.style.display = 'none';
                    elements.outputContainer.style.display = 'none';
                    elements.translateBtnText.textContent = 'Translate & Download ZIP';
                }
            }
            
            // --- FILE HANDLING ---
            function handleSingleFile(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => { elements.inputText.value = e.target.result; };
                    reader.readAsText(file);
                }
            }

            function handleMultiFile(event) {
                filesToProcess = Array.from(event.target.files);
                if (filesToProcess.length > 0) {
                    elements.fileListInfo.textContent = `${filesToProcess.length} file(s) selected.`;
                } else {
                    elements.fileListInfo.textContent = 'Select multiple .txt files to translate and zip.';
                }
            }

            // --- PRIMARY ACTION HANDLER ---
            function handlePrimaryAction() {
                if (currentMode === 'text') {
                    runSingleTranslation();
                } else {
                    runBatchTranslation();
                }
            }
            
            // --- TRANSLATION LOGIC ---
            async function runSingleTranslation() {
                const textToTranslate = elements.inputText.value.trim();
                if (!textToTranslate) {
                    showMessage('Please enter text or upload a file to translate.');
                    return;
                }
                
                setUIState('loading', 'Translating with AI...');
                translatedContent = '';
                
                try {
                    const result = await getTranslation(textToTranslate);
                    translatedContent = result;
                    let htmlContent = result.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>').replace(/\n/g, '<br>');
                    elements.outputText.innerHTML = `<div class="prose prose-invert max-w-none prose-p:my-2 prose-headings:my-3">${htmlContent}</div>`;
                } catch (error) {
                    handleError(error);
                } finally {
                    setUIState('idle');
                }
            }

            async function runBatchTranslation() {
                if (filesToProcess.length === 0) {
                    showMessage('Please select files for batch translation.');
                    return;
                }
                
                switchMode('text'); // Switch back to show progress
                setUIState('loading', `Starting batch translation...`);
                
                const zip = new JSZip();
                let successCount = 0;

                for (let i = 0; i < filesToProcess.length; i++) {
                    const file = filesToProcess[i];
                    setUIState('loading', `Translating file ${i + 1} of ${filesToProcess.length}: ${file.name}`);
                    
                    try {
                        const fileContent = await file.text();
                        const translatedText = await getTranslation(fileContent);
                        
                        const translatedFileName = file.name.replace('.txt', '_translated.txt');
                        zip.file(translatedFileName, translatedText);
                        successCount++;
                        
                        if (i < filesToProcess.length - 1) {
                            await new Promise(resolve => setTimeout(resolve, 1000));
                        }
                    } catch (error) {
                         showMessage(`Failed to translate ${file.name}: ${error.message}. Skipping.`);
                    }
                }

                if (successCount > 0) {
                    setUIState('loading', 'Zipping files...');
                    zip.generateAsync({ type: "blob" })
                        .then(function(content) {
                            downloadFile(content, "translated_files.zip", "application/zip");
                        });
                } else {
                    showMessage('Batch translation failed. No files were processed.');
                }
                
                handleError(); // Resets UI to placeholder state
                filesToProcess = []; // Clear file list
                elements.fileListInfo.textContent = 'Select multiple .txt files to translate and zip.';
            }

            async function getTranslation(text) {
                let apiKey = (window.GEMINI_API_KEY && window.GEMINI_API_KEY.length > 0) ? window.GEMINI_API_KEY : elements.apiKeyInput.value.trim();
                if (!apiKey) {
                    throw new Error('Please provide a Gemini API key.');
                }

                const selectedModel = elements.modelSelector.value;
                const literaryPrompt = elements.promptText.value;
                const fullPrompt = `${literaryPrompt}\n\nTranslate the following text:\n\n---\n\n${text}`;
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${selectedModel}:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: fullPrompt }] }],
                        generationConfig: { temperature: 0.7, topK: 1, topP: 1, maxOutputTokens: 8192 },
                    }),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error ? errorData.error.message : 'API request failed');
                }

                const data = await response.json();
                if (data.candidates && data.candidates[0].content.parts[0].text) {
                    return data.candidates[0].content.parts[0].text;
                } else if (data.promptFeedback && data.promptFeedback.blockReason) {
                    throw new Error(`Translation blocked. Reason: ${data.promptFeedback.blockReason}`);
                } else {
                    throw new Error('Received an empty response from the API.');
                }
            }


            // --- UTILITY FUNCTIONS ---
            function showMessage(message, duration = 4000) {
                elements.messageText.textContent = message;
                elements.messageBox.classList.remove('hidden');
                setTimeout(() => { elements.messageBox.classList.add('hidden'); }, duration);
            }

            function setUIState(state, loadingMsg = '') {
                if (state === 'loading') {
                    elements.loadingIndicator.classList.remove('hidden');
                    elements.loadingIndicator.classList.add('flex');
                    elements.placeholder.classList.add('hidden');
                    elements.loadingText.textContent = loadingMsg;
                    elements.translateBtn.disabled = true;
                    elements.translateBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    elements.outputText.innerHTML = ''; // Clear previous content
                    elements.outputText.appendChild(elements.loadingIndicator);
                } else { // idle state
                    elements.loadingIndicator.classList.add('hidden');
                    elements.translateBtn.disabled = false;
                    elements.translateBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
                const hasContent = translatedContent.length > 0;
                elements.copyBtn.disabled = !hasContent;
                elements.downloadMdBtn.disabled = !hasContent;
            }

            function handleError(error) {
                if (error) {
                    console.error('Translation Error:', error);
                    showMessage(`Error: ${error.message}`);
                }
                setUIState('idle');
                elements.outputText.innerHTML = '';
                elements.outputText.appendChild(elements.placeholder);
                elements.placeholder.classList.remove('hidden');
            }

            function downloadFile(content, fileName, contentType) {
                const a = document.createElement('a');
                const file = new Blob([content], { type: contentType });
                a.href = URL.createObjectURL(file);
                a.download = fileName;
                a.click();
                URL.revokeObjectURL(a.href);
            }
            
            function toggleApiVisibility() {
                const icon = elements.toggleApiVisibilityBtn.querySelector('i');
                if (elements.apiKeyInput.type === 'password') {
                    elements.apiKeyInput.type = 'text';
                    icon.classList.replace('fa-eye', 'fa-eye-slash');
                } else {
                    elements.apiKeyInput.type = 'password';
                    icon.classList.replace('fa-eye-slash', 'fa-eye');
                }
            }

            function copyOutput() {
                const textarea = document.createElement('textarea');
                textarea.value = translatedContent;
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                    elements.copyBtnText.textContent = 'Copied!';
                    setTimeout(() => { elements.copyBtnText.textContent = 'Copy'; }, 2000);
                } catch (err) {
                    showMessage('Failed to copy text.');
                }
                document.body.removeChild(textarea);
            }

        });
    </script>

</body>
</html>
