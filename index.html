<!DOCTYPE html>
<html lang="en" class="">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>AI Novel Translator</title>
        <!--
        Tailwind CSS for production: Remove CDN below and use a local tailwind.css file.
        Generate with: npx tailwindcss -i ./input.css -o ./tailwind.css --minify
        See https://tailwindcss.com/docs/installation for details.
        -->
        <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
        <link rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
            rel="stylesheet">
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
        <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #1f2937;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .tab-active {
            background-color: #3b82f6;
            color: white;
        }
        .tab-inactive {
            background-color: #374151;
            color: #d1d5db;
        }
        /* Styles for collapsible prompt */
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        /* Dark/Light mode styles */
        .bg-gray-900 {
            background-color: #111827;
        }
        .bg-gray-800 {
            background-color: #1f2937;
        }
        .bg-gray-700 {
            background-color: #374151;
        }
        .bg-gray-600 {
            background-color: #4b5563;
        }
        .bg-gray-500 {
            background-color: #6b7280;
        }
        .text-gray-200 {
            color: #e5e7eb;
        }
        .text-gray-300 {
            color: #d1d5db;
        }
        .text-gray-400 {
            color: #9ca3af;
        }
        .text-gray-500 {
            color: #6b7280;
        }
        .text-gray-600 {
            color: #4b5563;
        }
        .text-gray-700 {
            color: #374151;
        }
        .text-gray-800 {
            color: #1f2937;
        }
        .text-gray-900 {
            color: #111827;
        }
        </style>
        <script>
        window.GEMINI_API_KEY = ""; 
    </script>
    </head>
    <body class="bg-gray-900 text-gray-200 flex flex-col min-h-screen">

        <!-- Header -->
        <header
            class="bg-gray-800/50 backdrop-blur-sm border-b border-gray-700 sticky top-0 z-20">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center space-x-3">
                        <i class="fas fa-book-open text-2xl text-blue-400"></i>
                        <h1
                            class="text-xl font-bold tracking-tight text-white">AI
                            Novel Translator</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <a href="https://github.com/deva-hari/Translator-V2"
                            target="_blank"
                            class="text-gray-400 hover:text-white transition-colors">
                            <i class="fab fa-github text-2xl"></i>
                        </a>
                        <a href="https://d3va-splitter.streamlit.app/" target="_blank" class="text-gray-400 hover:text-white transition-colors flex items-center space-x-1 ml-4">
                            <i class="fas fa-scissors"></i><span class="hidden sm:inline">Splitter</span>
                        </a>
                        <a href="https://d3va-extractor.streamlit.app/" target="_blank" class="text-gray-400 hover:text-white transition-colors flex items-center space-x-1 ml-2">
                            <i class="fas fa-file-code"></i><span class="hidden sm:inline">Extractor</span>
                        </a>
                        <!-- Dark/Light Mode Toggle -->
                        <div class="flex items-center space-x-2 ml-4">
                            <button id="themeToggle" aria-label="Toggle dark/light mode" class="text-gray-400 hover:text-yellow-400 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded transition-colors">
                                <i class="fas fa-moon"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-grow container mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="flex flex-col space-y-6">

                <!-- Settings Section -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
                        <label for="providerSelector" class="block text-sm font-medium text-gray-400 mb-2">Provider</label>
                        <select id="providerSelector" class="w-full bg-gray-900 border border-gray-600 rounded-md px-4 py-2 text-white focus:ring-2 focus:ring-blue-500 focus:outline-none">
                            <option value="gemini">Gemini (Google AI Studio)</option>
                            <option value="groq">GroqCloud</option>
                            <option value="chuttes">Chuttes AI</option>
                            <option value="openrouter">OpenRouter</option>
                        </select>
                    </div>
                    <div id="apiKeyContainer" class="bg-gray-800 p-4 rounded-lg border border-gray-700">
                        <label for="apiKey" class="block text-sm font-medium text-gray-400 mb-2">API Key</label>
                        <div class="relative">
                            <input type="password" id="apiKey" class="w-full bg-gray-900 border border-gray-600 rounded-md px-4 py-2 text-white focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="Enter your API Key">
                            <button id="toggleApiVisibility" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-500 hover:text-gray-300"><i class="fas fa-eye"></i></button>
                        </div>
                        <div id="apiKeyHelp" class="text-xs text-gray-500 mt-2"></div>
                    </div>
                    <div class="bg-gray-800 p-4 rounded-lg border border-gray-700 col-span-1 md:col-span-2">
                        <label for="modelSelector" class="block text-sm font-medium text-gray-400 mb-2">Choose a Model</label>
                        <select id="modelSelector" class="w-full bg-gray-900 border border-gray-600 rounded-md px-4 py-2 text-white focus:ring-2 focus:ring-blue-500 focus:outline-none"></select>
                        <p id="modelHelp" class="text-xs text-gray-500 mt-2"></p>
                    </div>
                </div>

                <!-- Input Section -->
                <div class="bg-gray-800 rounded-lg border border-gray-700 p-4">
                    <div class="mb-4 border-b border-gray-700">
                        <nav class="flex space-x-2" aria-label="Tabs">
                            <button id="tab-text"
                                class="tab-active px-4 py-2 text-sm font-medium rounded-t-md">Text
                                / Single File</button>
                            <button id="tab-batch"
                                class="tab-inactive px-4 py-2 text-sm font-medium rounded-t-md">Multiple
                                Files (Batch)</button>
                        </nav>
                    </div>

                    <!-- Collapsible Prompt Section -->
                    <div class="mb-4">
                        <button id="prompt-toggle"
                            class="w-full flex justify-between items-center text-left p-3 bg-gray-700 hover:bg-gray-600 rounded-md">
                            <span class="font-medium text-gray-200">Customize
                                Translation Prompt</span>
                            <i id="prompt-chevron"
                                class="fas fa-chevron-down transition-transform"></i>
                        </button>
                        <div id="prompt-content" class="collapsible-content">
                            <textarea id="promptText"
                                class="w-full h-48 mt-2 bg-gray-900 p-3 text-gray-300 resize-none focus:outline-none rounded-md custom-scrollbar"></textarea>
                        </div>
                    </div>

                    <!-- Prompt Presets -->
                    <div class="mb-2 flex flex-wrap gap-2" role="group" aria-label="Prompt Presets">
                        <button class="prompt-preset bg-gray-700 hover:bg-blue-600 text-gray-200 px-3 py-1 rounded text-xs focus:outline-none focus:ring-2 focus:ring-blue-500" data-preset="literal">Literal</button>
                        <button class="prompt-preset bg-gray-700 hover:bg-blue-600 text-gray-200 px-3 py-1 rounded text-xs focus:outline-none focus:ring-2 focus:ring-blue-500" data-preset="creative">Creative</button>
                        <button class="prompt-preset bg-gray-700 hover:bg-blue-600 text-gray-200 px-3 py-1 rounded text-xs focus:outline-none focus:ring-2 focus:ring-blue-500" data-preset="just">Just Translate</button>
                    </div>

                    <!-- Text / Single File Input -->
                    <div id="panel-text">
                        <textarea id="inputText"
                            class="w-full h-48 bg-gray-900 p-4 text-gray-300 resize-none focus:outline-none rounded-md custom-scrollbar"
                            placeholder="Paste your Chinese novel text here, or upload a single .txt file..."
                            aria-label="Chinese novel input area (supports drag-and-drop .txt file upload)"></textarea>
                        <div class="flex justify-between items-center mt-3">
                            <label for="singleFileInput"
                                class="cursor-pointer px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md text-sm font-medium transition-colors flex items-center space-x-2">
                                <i class="fas fa-upload"></i>
                                <span>Upload Single .txt</span>
                            </label>
                            <input type="file" id="singleFileInput"
                                class="hidden" accept=".txt">
                            <button id="clearBtn"
                                class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-md text-sm font-medium transition-colors">Clear</button>
                        </div>
                    </div>

                    <!-- Multiple File Input -->
                    <div id="panel-batch" class="hidden">
                        <div
                            class="flex flex-col items-center justify-center border-2 border-dashed border-gray-600 rounded-lg p-10">
                            <i
                                class="fas fa-folder-open text-4xl text-gray-500 mb-4"></i>
                            <label for="multiFileInput"
                                class="relative cursor-pointer bg-blue-600 text-white font-medium py-2 px-4 rounded-md hover:bg-blue-700">
                                <span>Select Files</span>
                                <input id="multiFileInput" type="file" multiple
                                    class="sr-only" accept=".txt">
                            </label>
                            <p class="mt-2 text-sm text-gray-500"
                                id="file-list-info">Select multiple .txt files
                                to translate and zip.</p>
                        </div>
                    </div>
                    <!-- Translate Action Button -->
                    <div class="mt-6 flex justify-center">
                        <button id="translateBtn"
                            class="px-8 py-4 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg text-lg transition-all transform hover:scale-105 shadow-lg shadow-blue-500/20 flex items-center space-x-3">
                            <i class="fas fa-language text-2xl"></i>
                            <span id="translateBtnText">Translate Now</span>
                        </button>
                    </div>
                </div>

                <!-- Output Section -->
                <div id="outputContainer"
                    class="bg-gray-800 rounded-lg border border-gray-700 min-h-[300px] flex flex-col overflow-hidden">
                    <div
                        class="flex items-center justify-between p-3 border-b border-gray-700 bg-gray-800">
                        <h2 id="outputTitle"
                            class="font-semibold text-lg">Translated Text</h2>
                        <div id="outputActions"
                            class="flex items-center space-x-2">
                            <button id="copyBtn"
                                class="px-3 py-1 bg-gray-600 hover:bg-gray-700 text-white rounded-md text-sm font-medium transition-colors flex items-center space-x-2"
                                disabled>
                                <i class="fas fa-copy"></i>
                                <span id="copyBtnText">Copy</span>
                            </button>
                            <button id="downloadMdBtn"
                                class="px-3 py-1 bg-green-600 hover:bg-green-700 text-white rounded-md text-sm font-medium transition-colors flex items-center space-x-2"
                                disabled>
                                <i class="fas fa-download"></i>
                                <span>.md</span>
                            </button>
                        </div>
                    </div>
                    <div id="outputText"
                        class="w-full h-full flex-grow bg-gray-900 p-6 text-gray-300 overflow-y-auto custom-scrollbar prose prose-invert max-w-none prose-p:my-2 prose-headings:my-3">
                        <div id="placeholder"
                            class="flex flex-col items-center justify-center h-full text-gray-500">
                            <i class="fas fa-magic text-4xl mb-4"></i>
                            <p class="text-center">Your translated text will
                                appear here.</p>
                        </div>
                        <div id="loadingIndicator"
                            class="hidden flex-col items-center justify-center h-full text-gray-400">
                            <div class="loader"></div>
                            <p id="loadingText"
                                class="mt-4 text-center">Translating with AI...
                                this may take a moment.</p>
                        </div>
                    </div>
                </div>

                <!-- API Quota Info -->
                <div id="apiQuotaInfo" class="text-xs text-gray-400 mt-1" aria-live="polite"></div>

                <!-- Translation History Panel -->
                <div id="historyPanel" class="fixed bottom-5 left-5 bg-gray-800 border border-gray-700 rounded-lg shadow-lg z-50 w-80 max-h-96 overflow-y-auto hidden">
                    <div class="flex items-center justify-between px-4 py-2 border-b border-gray-700">
                        <span class="font-semibold text-white">Translation History</span>
                        <div class="flex items-center space-x-2">
                            <button id="clearHistoryBtn" class="text-gray-400 hover:text-white"><i class="fas fa-trash"></i></button>
                            <button id="closeHistoryBtn" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
                        </div>
                    </div>
                    <ul id="historyList" class="divide-y divide-gray-700"></ul>
                </div>
                <button id="showHistoryBtn" class="fixed bottom-5 left-5 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-full shadow-lg z-50 flex items-center space-x-2">
                    <i class="fas fa-history"></i><span>History</span>
                </button>

                <!-- Word/Character Count Display -->
                <div class="flex justify-between text-xs text-gray-400 mt-2">
                    <span id="inputCount">Input: 0 words, 0 chars</span>
                    <span id="outputCount">Output: 0 words, 0 chars</span>
                </div>

                <!-- API Usage Stats -->
                <div id="apiStats" class="fixed top-5 right-5 bg-gray-800 border border-gray-700 text-gray-200 px-4 py-2 rounded-lg shadow z-50 text-xs flex items-center space-x-2">
                    <i class="fas fa-signal"></i>
                    <span id="apiStatsText">Requests: 0</span>
                </div>
            </div>

            <!-- Message Box -->
            <div id="messageBox"
                class="hidden fixed bottom-5 right-5 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg z-50">
                <p id="messageText"></p>
            </div>
        </main>

        <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- PROVIDER/MODEL DATA ---
            const PROVIDERS = {
                gemini: {
                    name: 'Gemini (Google AI Studio)',
                    apiKeyHelp: 'Get your API key at https://aistudio.google.com/app/apikey',
                    models: [
                        { value: 'gemini-2.5-flash', label: 'Gemini 2.5 Flash (Higher Quality)' },
                        { value: 'gemini-2.0-flash', label: 'Gemini 2.0 (Fast & Efficient)' },
                        { value: 'gemini-2.5-flash-lite-preview-06-17', label: 'Gemini 2.5 Flash Lite (Stupid Fast, So-So)' },
                        { value: 'gemini-2.0-flash-lite', label: 'Gemini 2.0 Flash (Stupid Fast, So-So)' }
                    ],
                    modelHelp: 'Free tier: 60 requests/minute. Batch translation includes a 1s delay per file.'
                },
                groq: {
                    name: 'GroqCloud',
                    apiKeyHelp: 'Get your API key at https://console.groq.com/keys',
                    models: [
                        { value: 'llama3-70b-8192', label: 'Llama 3 70B (Best Quality, Free Tier)' },
                        { value: 'llama3-8b-8192', label: 'Llama 3 8B (Fastest, Free Tier)' },
                        { value: 'llama-3.1-8b-instant', label: 'Llama 3.1 8B Instant (Free Tier)' },
                        { value: 'llama-3.3-70b-versatile', label: 'Llama 3.3 70B Versatile (Free Tier)' },
                        { value: 'gemma2-9b-it', label: 'Gemma 2 9B IT (Free Tier)' },
                        { value: 'mixtral-8x7b-32768', label: 'Mixtral 8x7B (Long Context, Free Tier)' },
                        { value: 'gemma-7b-it', label: 'Gemma 7B IT (Free Tier)' }
                    ],
                    modelHelp: 'GroqCloud free tier: 10M tokens/month, blazing fast.'
                },
                chuttes: {
                    name: 'Chuttes AI',
                    apiKeyHelp: 'Get your API key at https://chuttes.ai/',
                    models: [
                        { value: 'chuttes-llama3-70b', label: 'Llama 3 70B (Chuttes, Free Tier)' },
                        { value: 'chuttes-mixtral-8x7b', label: 'Mixtral 8x7B (Chuttes, Free Tier)' }
                    ],
                    modelHelp: 'Chuttes AI free tier: generous limits, see website.'
                },
                openrouter: {
                    name: 'OpenRouter',
                    apiKeyHelp: 'Get your API key at https://openrouter.ai/',
                    models: [
                        { value: 'deepseek/deepseek-chat-v3-0324:free', label: 'Deepseek Chat V3 (OpenRouter, Free Tier)' },
                        { value: 'deepseek/deepseek-chat:free', label: 'Deepseek Chat (OpenRouter, Free Tier)' },
                        { value: 'qwen/qwq-32b:free', label: 'Mistral 7B (OpenRouter, Free Tier)' }
                    ],
                    modelHelp: 'OpenRouter free tier: see https://openrouter.ai/pricing.'
                }
            };

            const providerSelector = document.getElementById('providerSelector');
            const modelSelector = document.getElementById('modelSelector');
            const apiKeyHelp = document.getElementById('apiKeyHelp');
            const modelHelp = document.getElementById('modelHelp');

            function updateProviderUI() {
                const provider = providerSelector.value;
                const info = PROVIDERS[provider];
                // Update API key help
                apiKeyHelp.textContent = info.apiKeyHelp;
                // Update model selector
                modelSelector.innerHTML = '';
                info.models.forEach(m => {
                    const opt = document.createElement('option');
                    opt.value = m.value;
                    opt.textContent = m.label;
                    modelSelector.appendChild(opt);
                });
                // Update model help
                modelHelp.textContent = info.modelHelp;
            }
            providerSelector.addEventListener('change', updateProviderUI);
            updateProviderUI();
            // --- GLOBAL STATE ---
            let currentMode = 'text'; // 'text' or 'batch'
            let translatedContent = '';
            let filesToProcess = [];
            // ðŸŒŸ WILD & CREATIVE DEFAULT PROMPT ðŸŒŸ
            const defaultPrompt = `{
  "role": "expert_literary_translator",
  "language_pair": "Chinese-to-English",
  "specialization": "literary fiction, cultural nuance, idioms, slang, honorifics, internet references",
  "translation_style": {
    "tone": "natural, polished, emotionally rich, refined but accessible",
    "pacing": "well-paced, smooth",
    "audience": "international fiction readers, including non-native speakers",
    "vocabulary_level": "refined but easy to understand; avoid obscure or overly complex words"
  },
  "translation_guidelines": {
    "preserve_tone_and_style": true,
    "retain_paragraph_structure": true,
    "keep_names_in_pinyin": true,
    "idioms": {
      "translate": "use English equivalent",
      "append_pinyin": true,
      "example": "A single spark can start a prairie fire (XÄ«ngxÄ«ng zhÄ« huÇ’, kÄ›yÇ liÃ¡oyuÃ¡n)"
    },
    "internet_slang": {
      "retain_original": true,
      "add_footnote_explanation": true,
      "common_terms_example": ["yyds", "awsl", "xswl", "zqsg", "tql", "nb", "gg", "666", "carry", "AFK", "rush", "gank", "noob"]
    },
    "honorifics": {
      "preserve_all": true,
      "examples": {
        "prefixes": ["Lao", "Xiao", "Da", "A"],
        "suffixes": ["er", "zi", "tou", "wa"],
        "titles": ["Shifu", "Daozhang", "Xiansheng", "Gege", "Jiejie", "Shixiong", "Shimei", "Zongzhu", "Zhangmen", "Zhanglao", "Dizi", "Nei Men Dizi", "Wai Men Dizi", "Xianzun", "Zhenjun", "Shangxian", "Daozu", "Shishu", "Shibo", "Shizu"]
      }
    },
    "wordplay": {
      "preserve_or_explain": true,
      "reconstruct_if_needed": true
    },
    "cultural_terms": {
      "keep_pinyin": true,
      "brief_explanation_on_first_use": true,
      "footnote": true
    },
    "memes_and_references": {
      "preserve_reference": true,
      "footnote_explanation": true
    }
  },
  "formatting_requirements": {
    "chapter_title": "Chapter {number}: {title}",
    "paragraph_spacing": "one_blank_line_between_paragraphs",
    "dialogue": "quoted with indentation",
    "italics": ["internal thoughts", "emphasis", "spiritual transmissions"],
    "footnotes": {
      "max_count": 10,
      "format": "numbered at end",
      "content_types": [
        "cultural context",
        "slang/internet explanations",
        "idioms/references",
        "wordplay/puns",
        "honorifics/ranks",
        "memes"
      ]
    }
  },
  "quality_checklist": {
    "natural_smooth_english": true,
    "no_content_lost_or_added": true,
    "faithful_emotion_style": true,
    "consistent_names_and_terms": true,
    "clear_dialogue": true,
    "idiom_slang_reference_handling": true,
    "honorifics_formatting_consistent": true,
    "puns_and_double_meanings": "translated or footnoted",
    "no_chinese_characters": true,
    "all_translation_contextually_accurate": true,
    "international_readability": true,
    "suitable_for_publication": true,
    "footnotes_present" : true, 
    "suggestive_content_allowed" : true
  },
  "postprocessing_steps": [
    "Review translation recursively 3 times for flow, tone, and accuracy",
    "Fix any grammatical or conceptual errors based on deeper context understanding",
    "Ensure all formatting and cultural references are properly handled"
  ],
  "output": {
    "format": "full translated chapter with paragraph structure and footnotes, provide only output, no instructions"
  }
}`;


            // --- ELEMENT REFERENCES ---
            const elements = {
                apiKeyContainer: document.getElementById('apiKeyContainer'),
                apiKeyInput: document.getElementById('apiKey'),
                toggleApiVisibilityBtn: document.getElementById('toggleApiVisibility'),
                modelSelector: document.getElementById('modelSelector'),
                inputText: document.getElementById('inputText'),
                outputText: document.getElementById('outputText'),
                outputContainer: document.getElementById('outputContainer'),
                outputTitle: document.getElementById('outputTitle'),
                outputActions: document.getElementById('outputActions'),
                translateBtn: document.getElementById('translateBtn'),
                translateBtnText: document.getElementById('translateBtnText'),
                clearBtn: document.getElementById('clearBtn'),
                singleFileInput: document.getElementById('singleFileInput'),
                multiFileInput: document.getElementById('multiFileInput'),
                fileListInfo: document.getElementById('file-list-info'),
                copyBtn: document.getElementById('copyBtn'),
                copyBtnText: document.getElementById('copyBtnText'),
                downloadMdBtn: document.getElementById('downloadMdBtn'),
                placeholder: document.getElementById('placeholder'),
                loadingIndicator: document.getElementById('loadingIndicator'),
                loadingText: document.getElementById('loadingText'),
                messageBox: document.getElementById('messageBox'),
                messageText: document.getElementById('messageText'),
                tabText: document.getElementById('tab-text'),
                tabBatch: document.getElementById('tab-batch'),
                panelText: document.getElementById('panel-text'),
                panelBatch: document.getElementById('panel-batch'),
                promptToggle: document.getElementById('prompt-toggle'),
                promptContent: document.getElementById('prompt-content'),
                promptChevron: document.getElementById('prompt-chevron'),
                promptText: document.getElementById('promptText'),
                showHistoryBtn: document.getElementById('showHistoryBtn'),
                historyPanel: document.getElementById('historyPanel'),
                historyList: document.getElementById('historyList'),
                closeHistoryBtn: document.getElementById('closeHistoryBtn'),
                inputCount: document.getElementById('inputCount'),
                outputCount: document.getElementById('outputCount'),
                apiStats: document.getElementById('apiStats'),
                apiStatsText: document.getElementById('apiStatsText'),
                themeToggle: document.getElementById('themeToggle'),
                apiQuotaInfo: document.getElementById('apiQuotaInfo'),
            };

            // --- GLOBAL STATE (ensure these are defined before use) ---
            let translationHistory = JSON.parse(localStorage.getItem('translationHistory') || '[]');
            let apiRequestCount = Number(localStorage.getItem('apiRequestCount') || 0);

            // --- INITIALIZATION ---
            updateHistoryPanel(); // Ensure history is displayed even before any new translation
            updateApiStats();


            // --- API KEY PER PROVIDER ---
            function getApiKeyStorageKey(provider) {
                return `${provider}ApiKey`;
            }

            function updateApiKeyInput() {
                const provider = providerSelector.value;
                // If a global env var is set for Gemini, hide input
                if (provider === 'gemini' && window.GEMINI_API_KEY && window.GEMINI_API_KEY.length > 0) {
                    elements.apiKeyContainer.style.display = 'none';
                } else {
                    elements.apiKeyContainer.style.display = '';
                    elements.apiKeyInput.value = localStorage.getItem(getApiKeyStorageKey(provider)) || '';
                }
            }

            // Save API key to localStorage per provider
            elements.apiKeyInput.addEventListener('input', () => {
                const provider = providerSelector.value;
                localStorage.setItem(getApiKeyStorageKey(provider), elements.apiKeyInput.value);
            });

            // When provider changes, update API key input
            providerSelector.addEventListener('change', updateApiKeyInput);
            updateApiKeyInput();

            elements.promptText.value = defaultPrompt;

            // --- API USAGE STATS ---
            function updateApiStats() {
                elements.apiStatsText.textContent = `Requests: ${apiRequestCount}`;
            }

            // --- HISTORY PANEL FUNCTIONS ---
            function updateHistoryPanel() {
                const list = elements.historyList;
                list.innerHTML = '';
                if (translationHistory.length === 0) {
                    list.innerHTML = '<li class="p-4 text-gray-400 text-center">No history yet.</li>';
                    return;
                }
                translationHistory.slice().reverse().forEach((item, idx) => {
                    const li = document.createElement('li');
                    li.className = "p-3 hover:bg-gray-700 transition";
                    li.innerHTML = `
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-semibold text-sm text-blue-300">#${translationHistory.length - idx}</span>
                            <span class="text-xs text-gray-400">${item.time}</span>
                        </div>
                        <div class="mb-2 max-h-16 overflow-y-auto text-gray-300 text-xs"><strong>Input:</strong> ${item.input.slice(0, 100)}${item.input.length > 100 ? '...' : ''}</div>
                        <div class="mb-2 max-h-16 overflow-y-auto text-gray-300 text-xs"><strong>Output:</strong> ${item.output.slice(0, 100)}${item.output.length > 100 ? '...' : ''}</div>
                        <div class="flex space-x-2">
                            <button class="copyHistBtn bg-gray-600 hover:bg-gray-700 text-white px-2 py-1 rounded text-xs" data-idx="${translationHistory.length - 1 - idx}"><i class="fas fa-copy"></i> Copy</button>
                            <button class="downloadHistBtn bg-green-600 hover:bg-green-700 text-white px-2 py-1 rounded text-xs" data-idx="${translationHistory.length - 1 - idx}"><i class="fas fa-download"></i> .md</button>
                        </div>
                    `;
                    list.appendChild(li);
                });
                // Attach copy/download handlers
                list.querySelectorAll('.copyHistBtn').forEach(btn => {
                    btn.onclick = (e) => {
                        const idx = Number(btn.dataset.idx);
                        const text = translationHistory[idx].output;
                        navigator.clipboard.writeText(text);
                        showMessage('Copied translation from history!');
                    };
                });
                list.querySelectorAll('.downloadHistBtn').forEach(btn => {
                    btn.onclick = (e) => {
                        const idx = Number(btn.dataset.idx);
                        const text = translationHistory[idx].output;
                        downloadFile(text, `translation_${idx + 1}.md`, 'text/markdown');
                    };
                });
            }

            // --- EVENT LISTENERS ---
            elements.toggleApiVisibilityBtn.addEventListener('click', toggleApiVisibility);
            elements.promptToggle.addEventListener('click', togglePromptVisibility);
            elements.clearBtn.addEventListener('click', () => { elements.inputText.value = ''; });
            elements.singleFileInput.addEventListener('change', handleSingleFile);
            elements.multiFileInput.addEventListener('change', handleMultiFile);
            elements.translateBtn.addEventListener('click', handlePrimaryAction);
            elements.copyBtn.addEventListener('click', copyOutput);
            elements.downloadMdBtn.addEventListener('click', () => downloadFile(translatedContent, 'translation.md', 'text/markdown'));
            elements.tabText.addEventListener('click', () => switchMode('text'));
            elements.tabBatch.addEventListener('click', () => switchMode('batch'));

            // Toggle history panel on button click
            let historyPanelVisible = false;
            elements.showHistoryBtn.addEventListener('click', (e) => {
                historyPanelVisible = !historyPanelVisible;
                if (historyPanelVisible) {
                    elements.historyPanel.classList.remove('hidden');
                    elements.showHistoryBtn.classList.remove('opacity-30');
                } else {
                    elements.historyPanel.classList.add('hidden');
                    elements.showHistoryBtn.classList.add('opacity-30');
                }
                e.stopPropagation();
            });
            elements.closeHistoryBtn.addEventListener('click', () => {
                elements.historyPanel.classList.add('hidden');
                elements.showHistoryBtn.classList.add('opacity-30');
                historyPanelVisible = false;
            });

            document.addEventListener('click', (e) => {
                // If click is outside the history panel and button, hide the panel
                if (historyPanelVisible) {
                    const panel = elements.historyPanel;
                    const btn = elements.showHistoryBtn;
                    if (!panel.contains(e.target) && !btn.contains(e.target)) {
                        panel.classList.add('hidden');
                        btn.classList.add('opacity-30');
                        historyPanelVisible = false;
                    }
                } else {
                    // If not active, make button transparent
                    elements.showHistoryBtn.classList.add('opacity-30');
                }
            });
            // On load, make button transparent if panel is hidden
            if (elements.historyPanel.classList.contains('hidden')) {
                elements.showHistoryBtn.classList.add('opacity-30');
            }
            // Remove transparency on hover
            // Add event listeners for mouseenter and mouseleave

            // Only remove opacity if not active
            // On mouseenter
            elements.showHistoryBtn.addEventListener('mouseenter', () => {
                elements.showHistoryBtn.classList.remove('opacity-30');
            });
            // On mouseleave, only add opacity if not active
            elements.showHistoryBtn.addEventListener('mouseleave', () => {
                if (!historyPanelVisible) {
                    elements.showHistoryBtn.classList.add('opacity-30');
                }
            });

            elements.inputText.addEventListener('input', () => {
                updateCounts();
            });
            document.getElementById('clearHistoryBtn').addEventListener('click', () => {
                if (confirm('Clear all translation history?')) {
                    translationHistory = [];
                    localStorage.removeItem('translationHistory');
                    updateHistoryPanel();
                    showMessage('Translation history cleared!');
                }
            });
            elements.themeToggle.addEventListener('click', () => setTheme(theme === 'dark' ? 'light' : 'dark'));

            // --- UI FUNCTIONS ---
            function togglePromptVisibility() {
                const content = elements.promptContent;
                if (content.style.maxHeight) {
                    content.style.maxHeight = null;
                    elements.promptChevron.classList.remove('rotate-180');
                } else {
                    content.style.maxHeight = content.scrollHeight + "px";
                    elements.promptChevron.classList.add('rotate-180');
                }
            }

            function switchMode(mode) {
                currentMode = mode;
                if (mode === 'text') {
                    elements.tabText.classList.replace('tab-inactive', 'tab-active');
                    elements.tabBatch.classList.replace('tab-active', 'tab-inactive');
                    elements.panelText.style.display = 'block';
                    elements.panelBatch.style.display = 'none';
                    elements.outputContainer.style.display = 'flex';
                    elements.translateBtnText.textContent = 'Translate Now';
                } else { // batch mode
                    elements.tabBatch.classList.replace('tab-inactive', 'tab-active');
                    elements.tabText.classList.replace('tab-active', 'tab-inactive');
                    elements.panelBatch.style.display = 'block';
                    elements.panelText.style.display = 'none';
                    elements.outputContainer.style.display = 'none';
                    elements.translateBtnText.textContent = 'Translate & Download ZIP';
                }
            }
            
            // --- FILE HANDLING ---
            function handleSingleFile(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => { elements.inputText.value = e.target.result; };
                    reader.readAsText(file);
                }
            }

            function handleMultiFile(event) {
                filesToProcess = Array.from(event.target.files);
                if (filesToProcess.length > 0) {
                    elements.fileListInfo.textContent = `${filesToProcess.length} file(s) selected.`;
                } else {
                    elements.fileListInfo.textContent = 'Select multiple .txt files to translate and zip.';
                }
            }

            // --- PRIMARY ACTION HANDLER ---
            function handlePrimaryAction() {
                if (currentMode === 'text') {
                    runSingleTranslation();
                } else {
                    runBatchTranslation();
                }
            }
            
            // --- UTILITY FUNCTIONS ---
            function showMessage(message, duration = 3000) {
                const box = elements.messageBox;
                box.classList.remove('hidden');
                box.classList.remove('bg-red-500', 'bg-green-600');
                box.classList.add('bg-green-600');
                elements.messageText.textContent = message;
                setTimeout(() => { box.classList.add('hidden'); }, duration);
            }

            function setUIState(state, loadingMsg = '') {
                if (state === 'loading') {
                    elements.loadingIndicator.classList.remove('hidden');
                    elements.loadingIndicator.classList.add('flex');
                    elements.placeholder.classList.add('hidden');
                    elements.loadingText.textContent = loadingMsg;
                    elements.translateBtn.disabled = true;
                    elements.translateBtn.classList.add('opacity-30', 'cursor-not-allowed');
                    elements.outputText.innerHTML = '';
                    elements.outputText.appendChild(elements.loadingIndicator);
                } else { // idle state
                    elements.loadingIndicator.classList.add('hidden');
                    elements.translateBtn.disabled = false;
                    elements.translateBtn.classList.remove('opacity-30', 'cursor-not-allowed');
                }
                const hasContent = translatedContent.length > 0;
                elements.copyBtn.disabled = !hasContent;
                elements.downloadMdBtn.disabled = !hasContent;
            }

            function handleError(error) {
                if (error) {
                    console.error('Translation Error:', error);
                    showMessage(`Error: ${error.message}`);
                }
                setUIState('idle');
                elements.outputText.innerHTML = '';
                elements.outputText.appendChild(elements.placeholder);
                elements.placeholder.classList.remove('hidden');
            }

            function updateCounts() {
                const input = elements.inputText.value;
                const output = translatedContent || '';
                elements.inputCount.textContent = `Input: ${countWords(input)} words, ${input.length} chars`;
                elements.outputCount.textContent = `Output: ${countWords(output)} words, ${output.length} chars`;
            }
            function countWords(str) {
                return str.trim() ? str.trim().split(/\s+/).length : 0;
            }

            function copyOutput() {
                const textarea = document.createElement('textarea');
                textarea.value = translatedContent;
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                    elements.copyBtnText.textContent = 'Copied!';
                    setTimeout(() => { elements.copyBtnText.textContent = 'Copy'; }, 2000);
                } catch (err) {
                    showMessage('Failed to copy text.');
                }
                document.body.removeChild(textarea);
            }

            function downloadFile(content, fileName, contentType) {
                const a = document.createElement('a');
                const file = new Blob([content], { type: contentType });
                a.href = URL.createObjectURL(file);
                a.download = fileName;
                a.click();
                URL.revokeObjectURL(a.href);
            }

            // --- THEME (DARK/LIGHT) ---
            const themeToggle = document.getElementById('themeToggle');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            let theme = localStorage.getItem('theme') || (prefersDark ? 'dark' : 'light');
            setTheme(theme);
            function setTheme(mode) {
                theme = mode;
                const html = document.documentElement;
                if (mode === 'dark') {
                    html.classList.add('dark');
                } else {
                    html.classList.remove('dark');
                }
                themeToggle.innerHTML = mode === 'dark' ? '<i class="fas fa-moon"></i>' : '<i class="fas fa-sun"></i>';
                localStorage.setItem('theme', mode);
            }
            themeToggle.addEventListener('click', () => setTheme(theme === 'dark' ? 'light' : 'dark'));

            // --- PROMPT PRESETS ---
            const promptPresets = {
                literal: `Translate the Chinese text to English as literally and accurately as possible. Preserve sentence structure and meaning. No extra commentary.`,
                creative: defaultPrompt,
                just: `Translate the following Chinese text to English. No commentary, no extra formatting. Just translate.`
            };
            function setActivePreset(preset) {
                document.querySelectorAll('.prompt-preset').forEach(btn => {
                    if (btn.dataset.preset === preset) {
                        btn.classList.add('bg-blue-600', 'text-white');
                        btn.classList.remove('bg-gray-700', 'text-gray-200');
                    } else {
                        btn.classList.remove('bg-blue-600', 'text-white');
                        btn.classList.add('bg-gray-700', 'text-gray-200');
                    }
                });
                localStorage.setItem('promptPreset', preset);
            }
            document.querySelectorAll('.prompt-preset').forEach(btn => {
                btn.addEventListener('click', () => {
                    const preset = btn.dataset.preset;
                    elements.promptText.value = promptPresets[preset];
                    setActivePreset(preset);
                    saveSettings();
                });
            });
            // On load, set preset button state
            const savedPreset = localStorage.getItem('promptPreset');
            if (savedPreset && promptPresets[savedPreset]) {
                setActivePreset(savedPreset);
                elements.promptText.value = promptPresets[savedPreset];
            } else {
                setActivePreset('creative');
            }

            // --- PERSISTENT SETTINGS ---
            // Save/load model, prompt, theme, preset
            function saveSettings() {
                localStorage.setItem('model', elements.modelSelector.value);
                localStorage.setItem('prompt', elements.promptText.value);
                localStorage.setItem('theme', theme);
            }
            function loadSettings() {
                const model = localStorage.getItem('model');
                if (model) elements.modelSelector.value = model;
                const prompt = localStorage.getItem('prompt');
                if (prompt) elements.promptText.value = prompt;
                setTheme(localStorage.getItem('theme') || theme);
            }
            elements.modelSelector.addEventListener('change', saveSettings);
            elements.promptText.addEventListener('input', saveSettings);
            window.addEventListener('DOMContentLoaded', loadSettings);

            // --- DRAG-AND-DROP FILE UPLOAD ---
            const inputTextArea = elements.inputText;
            inputTextArea.addEventListener('dragover', e => {
                e.preventDefault();
                inputTextArea.classList.add('ring', 'ring-blue-500');
            });
            inputTextArea.addEventListener('dragleave', e => {
                e.preventDefault();
                inputTextArea.classList.remove('ring', 'ring-blue-500');
            });
            inputTextArea.addEventListener('drop', e => {
                e.preventDefault();
                inputTextArea.classList.remove('ring', 'ring-blue-500');
                const files = Array.from(e.dataTransfer.files).filter(f => f.name.endsWith('.txt'));
                if (files.length === 0) {
                    showMessage('Only .txt files are supported.');
                    return;
                }
                const reader = new FileReader();
                reader.onload = (ev) => { inputTextArea.value = ev.target.result; updateCounts(); };
                reader.readAsText(files[0]);
            });
            // Keyboard accessibility for drag-and-drop
            inputTextArea.addEventListener('keydown', e => {
                if ((e.key === 'Enter' || e.key === ' ') && e.ctrlKey) {
                    elements.singleFileInput.click();
                }
            });

            // Fix: after uploading file, pressing translate works (ensure inputText is updated)
            elements.singleFileInput.addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        elements.inputText.value = e.target.result;
                        updateCounts();
                    };
                    reader.readAsText(file);
                }
            });

            // --- TRANSLATION API FUNCTION ---
            async function getTranslation(text, retries = 2) {
                const provider = providerSelector.value;
                // Get API key for current provider
                let apiKey = elements.apiKeyInput.value.trim();
                if (!apiKey) {
                    // Try to load from localStorage (in case input is empty)
                    apiKey = localStorage.getItem(`${provider}ApiKey`) || '';
                }
                const selectedModel = modelSelector.value;
                const literaryPrompt = elements.promptText.value;
                if (!apiKey) throw new Error('Please provide an API key.');
                if (provider === 'gemini') {
                    const fullPrompt = `${literaryPrompt}\n\nTranslate the following text:\n\n---\n\n${text}`;
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${selectedModel}:generateContent?key=${apiKey}`;
                    try {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{ parts: [{ text: fullPrompt }] }],
                                generationConfig: { temperature: 0.7, topK: 1, topP: 1, maxOutputTokens: 8192 },
                            }),
                        });
                        if (!response.ok) {
                            const errorData = await response.json();
                            if (retries > 0 && (response.status >= 500 || response.status === 429)) {
                                await new Promise(res => setTimeout(res, 1500));
                                return getTranslation(text, retries - 1);
                            }
                            throw new Error(errorData.error ? errorData.error.message : 'API request failed');
                        }
                        const data = await response.json();
                        if (data.candidates && data.candidates[0].content.parts[0].text) {
                            return data.candidates[0].content.parts[0].text;
                        } else if (data.promptFeedback && data.promptFeedback.blockReason) {
                            throw new Error(`Translation blocked. Reason: ${data.promptFeedback.blockReason}`);
                        } else {
                            throw new Error('Received an empty response from the API.');
                        }
                    } catch (error) {
                        if (retries > 0) {
                            await new Promise(res => setTimeout(res, 1500));
                            return getTranslation(text, retries - 1);
                        }
                        throw error;
                    }
                } else if (provider === 'groq') {
                    const apiUrl = 'https://api.groq.com/openai/v1/chat/completions';
                    const body = {
                        model: selectedModel,
                        messages: [
                            { role: 'system', content: literaryPrompt },
                            { role: 'user', content: text }
                        ],
                        max_tokens: 8192
                    };
                    try {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${apiKey}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(body)
                        });
                        if (!response.ok) {
                            const errorData = await response.json();
                            if (retries > 0 && (response.status >= 500 || response.status === 429)) {
                                await new Promise(res => setTimeout(res, 1500));
                                return getTranslation(text, retries - 1);
                            }
                            throw new Error(errorData.error ? errorData.error.message : 'API request failed');
                        }
                        const data = await response.json();
                        if (data.choices && data.choices[0].message && data.choices[0].message.content) {
                            return data.choices[0].message.content;
                        } else {
                            throw new Error('Received an empty response from the API.');
                        }
                    } catch (error) {
                        if (retries > 0) {
                            await new Promise(res => setTimeout(res, 1500));
                            return getTranslation(text, retries - 1);
                        }
                        throw error;
                    }
                } else if (provider === 'chuttes') {
                    // Example endpoint, update as needed
                    const apiUrl = 'https://api.chuttes.ai/v1/chat/completions';
                    const body = {
                        model: selectedModel,
                        messages: [
                            { role: 'system', content: literaryPrompt },
                            { role: 'user', content: text }
                        ],
                        max_tokens: 8192
                    };
                    try {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${apiKey}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(body)
                        });
                        if (!response.ok) {
                            const errorData = await response.json();
                            if (retries > 0 && (response.status >= 500 || response.status === 429)) {
                                await new Promise(res => setTimeout(res, 1500));
                                return getTranslation(text, retries - 1);
                            }
                            throw new Error(errorData.error ? errorData.error.message : 'API request failed');
                        }
                        const data = await response.json();
                        if (data.choices && data.choices[0].message && data.choices[0].message.content) {
                            return data.choices[0].message.content;
                        } else {
                            throw new Error('Received an empty response from the API.');
                        }
                    } catch (error) {
                        if (retries > 0) {
                            await new Promise(res => setTimeout(res, 1500));
                            return getTranslation(text, retries - 1);
                        }
                        throw error;
                    }
                } else if (provider === 'openrouter') {
                    const apiUrl = 'https://openrouter.ai/api/v1/chat/completions';
                    const body = {
                        model: selectedModel,
                        messages: [
                            { role: 'system', content: literaryPrompt },
                            { role: 'user', content: text }
                        ],
                        max_tokens: 8192
                    };
                    try {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${apiKey}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(body)
                        });
                        if (!response.ok) {
                            const errorData = await response.json();
                            if (retries > 0 && (response.status >= 500 || response.status === 429)) {
                                await new Promise(res => setTimeout(res, 1500));
                                return getTranslation(text, retries - 1);
                            }
                            throw new Error(errorData.error ? errorData.error.message : 'API request failed');
                        }
                        const data = await response.json();
                        if (data.choices && data.choices[0].message && data.choices[0].message.content) {
                            return data.choices[0].message.content;
                        } else {
                            throw new Error('Received an empty response from the API.');
                        }
                    } catch (error) {
                        if (retries > 0) {
                            await new Promise(res => setTimeout(res, 1500));
                            return getTranslation(text, retries - 1);
                        }
                        throw error;
                    }
                } else {
                    throw new Error('Unknown provider selected.');
                }
            }

            // --- TRANSLATION LOGIC ---
            async function runSingleTranslation() {
                const textToTranslate = elements.inputText.value.trim();
                if (!textToTranslate) {
                    showMessage('Please enter text or upload a file to translate.');
                    return;
                }

                setUIState('loading', 'Translating with AI...');
                translatedContent = '';
                const startTime = Date.now(); // Start timer

                try {
                    const result = await getTranslation(textToTranslate);
                    translatedContent = result;
                    let htmlContent = result.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>').replace(/\n/g, '<br>');
                    elements.outputText.innerHTML = `<div class="prose prose-invert max-w-none prose-p:my-2 prose-headings:my-3">${htmlContent}</div>`;
                    const elapsed = ((Date.now() - startTime) / 1000).toFixed(2);
                    showMessage(`ðŸŽ‰ Translation finished in ${elapsed} seconds!`, 3000);

                    apiRequestCount++;
localStorage.setItem('apiRequestCount', apiRequestCount);
updateApiStats();

// Save to history
                    const now = new Date();
                    translationHistory.push({
                        input: textToTranslate,
                        output: result,
                        time: now.toLocaleTimeString()
                    });
                    if (translationHistory.length > 20) translationHistory.shift();
                    localStorage.setItem('translationHistory', JSON.stringify(translationHistory));
                    updateHistoryPanel();
                    updateCounts();
                } catch (error) {
                    handleError(error);
                } finally {
                    setUIState('idle');
                }
            }

            async function runBatchTranslation() {
                if (filesToProcess.length === 0) {
                    showMessage('Please select files for batch translation.');
                    return;
                }

                switchMode('text'); // Switch back to show progress
                setUIState('loading', `Starting batch translation...`);
                const zip = new JSZip();
                let successCount = 0;
                const startTime = Date.now(); // Start timer


                for (let i = 0; i < filesToProcess.length; i++) {
                    const file = filesToProcess[i];
                    setUIState('loading', `Translating file ${i + 1} of ${filesToProcess.length}: ${file.name}`);

                    try {
                        apiRequestCount++;
                        localStorage.setItem('apiRequestCount', apiRequestCount);
                        updateApiStats();

                        const fileContent = await file.text();
                        let translatedText = await getTranslation(fileContent);

                        // Remove HTML formatting for .md output (keep as plain markdown)
                        // If the model returns markdown, just save as is. If it returns HTML, convert to markdown.
                        // Here, we assume the model returns markdown/plaintext, so just save as is.

                        const translatedFileName = file.name.replace(/\.txt$/i, '_translated.md');
                        zip.file(translatedFileName, translatedText);
                        successCount++;

                        apiRequestCount++;
                        localStorage.setItem('apiRequestCount', apiRequestCount);
                        updateApiStats();

                        // Save to history
                        const now = new Date();
                        translationHistory.push({
                            input: fileContent,
                            output: translatedText,
                            time: now.toLocaleTimeString()
                        });
                        if (translationHistory.length > 20) translationHistory.shift();
                        localStorage.setItem('translationHistory', JSON.stringify(translationHistory));
                        updateHistoryPanel();

                        if (i < filesToProcess.length - 1) {
                            await new Promise(resolve => setTimeout(resolve, 1000));
                        }
                    } catch (error) {
                        showMessage(`Failed to translate ${file.name}: ${error.message}. Skipping.`);
                    }
                }

                if (successCount > 0) {
                    setUIState('loading', 'Zipping files...');
                    zip.generateAsync({ type: "blob" })
                        .then(function(content) {
                            downloadFile(content, "translated_files.zip", "application/zip");
                            const elapsed = ((Date.now() - startTime) / 1000).toFixed(2);
                            showMessage(`ðŸŽ‰ Batch translation finished in ${elapsed} seconds!`, 3000);
                        });
                } else {
                    showMessage('Batch translation failed. No files were processed.');
                }

                handleError(); // Resets UI to placeholder state
                filesToProcess = []; // Clear file list
                elements.fileListInfo.textContent = 'Select multiple .txt files to translate and zip.';
                updateCounts();
            }
        });
        </script>

    </body>
</html>
